"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Channel=void 0;function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var Channel=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"scalar",value:function scalar(a,b){var c=new Uint8Array(a).buffer;return"float"==b?new Float64Array(c)[0]:"Int32"==b?new Int32Array(c)[0]:void 0}},{key:"namePart",value:function namePart(a,b){return a.split(":")[b]||null}},{key:"isWildcard",value:function isWildcard(a){return /\*/.exec(a)}},{key:"isRange",value:function isRange(){}},{key:"containsRange",value:function containsRange(){}},{key:"compareNames",value:function compareNames(c,a){var b,d,e=/^(\d+)\-?(\d+)?$/,f=[],g=c.toString().split(":"),h=a.toString().split(":"),j=g.length;j<h.length&&(j=h.length);for(var q=0;q<j;q++){if(g.length>q)b=g[q];else if("*"==g[g.length-1])b=g[g.length-1];else return!1;if(h.length>q)d=h[q];else if("*"==h[h.length-1])d=h[h.length-1];else return!1;var i="*"===b?d:b;if(b!==d&&"*"!==b&&"*"!==d){var k=e.exec(b),l=e.exec(d);if(k&&l){var m=k[1],n=k[1],o=l[1],p=l[1];if(k[2]&&(n=k[2]),l[2]&&(p=l[2]),m>=o&&n<=p?i="".concat(m,"-").concat(n):m<=o&&n>p?i="".concat(o,"-").concat(p):n<=p&&n>=o?i="".concat(o,"-").concat(n):m<=p&&m>=o&&(i="".concat(m,"-").concat(p)),p<=n&&p>=m)i="".concat(m,"-").concat(p);else if(o<=n&&o>=m)i="".concat(o,"-").concat(n);else return!1}else return!1}f.push(i)}return f.join(":")}}]),a}();exports.Channel=Channel;
"use strict";var _Channel=require("./Channel");Object.defineProperty(exports,"__esModule",{value:!0}),exports.Socket=void 0;function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var Socket=function(){function a(b){_classCallCheck(this,a),this.socket=b,b.binaryType="arraybuffer",this.data={},this.listenerCount={},this.openQueue=[],this._onSend=[]}return _createClass(a,null,[{key:"get",value:function get(a){var b=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];return this.sockets||(this.sockets={}),(b||!this.sockets[a])&&(this.sockets[a]=new this(new WebSocket(a))),this.sockets[a]}}]),_createClass(a,[{key:"subscribe",value:function subscribe(a,b,c){var d=a.split(":"),e=d.shift(),f=d.join(":");b instanceof Function&&(c=b,b=f),f&&(!(f in this.listenerCount)&&(this.listenerCount[f]=0),this.listenerCount[f]++,this.send("sub ".concat(f)));var g=function(a,b,c,d){return function(f){var g={};try{if("string"==typeof f.data)g=JSON.parse(f.data);else if(f.data instanceof ArrayBuffer){var h=new Uint16Array(f.data,4,1)[0];if(!b||_Channel.Channel.compareNames(b,h))return void d(f,f.data.slice(6),h,new Uint16Array(f.data,0,1)[0]?"user":"server",new Uint16Array(f.data,2,1)[0],null,{})}else if("message"!==a)return void d(f)}catch(b){return void("message"!==a&&d(f))}return"object"===_typeof(g)?void(!b&&d(f,g.message,null,g.origin,g.originId,null,g),b&&"channel"in g&&_Channel.Channel.compareNames(b,g.channel)&&d(f,g.message,g.channel,g.origin,g.originId,g.originalChannel,g)):void(""===c&&d(f,f.data,null,"server",0,null,g))}}(e,b,f,c);return this.socket.addEventListener(e,g),g}},{key:"unsubscribe",value:function unsubscribe(a,b){var c=a.split(":"),d=c.shift(),e=c.join(":");e&&(this.listenerCount[e]--,e in this.listenerCount&&0<this.listenerCount[e]||(this.socket.removeEventListener(d,b),this.send("unsub ".concat(e))))}},{key:"publish",value:function publish(a,b){if(a==parseInt(a)){b instanceof ArrayBuffer?b=new Uint8Array(b):b.byteLength?b=new Uint8Array(b.buffer):!Array.isArray(b)&&(b=[b]);var c=new Uint8Array(new Uint16Array([a]).buffer),d=new Uint8Array(c.byteLength+b.byteLength);return d.set(c,0),d.set(b,c.byteLength),void this.send(d)}this.send("pub ".concat(a," ").concat(b))}},{key:"send",value:function send(a){var b=this;if(this.socket.readyState!==this.socket.OPEN)return new Promise(function(d){var e=function(a){return function(){for(;b.openQueue.length;){var c=b.openQueue.shift();b.send(c)}b.socket.removeEventListener("open",a),d()}}(e);b.socket.addEventListener("open",e),b.openQueue.unshift(a)});for(var c in this._onSend)this._onSend[c](a);return this.socket.send(a),Promise.resolve()}},{key:"onSend",value:function onSend(a){this._onSend.push(a)}},{key:"close",value:function close(){this.socket.close()}},{key:"ping",value:function ping(){}},{key:"pong",value:function pong(){}}]),a}();exports.Socket=Socket;
